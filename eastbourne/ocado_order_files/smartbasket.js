'use strict';webshop.basket=webshop.basket||{};webshop.basket.SmartBasket={init:function(){this._checkDeviceSpecific();this._observeBasketEvents();this._registerPageListeners();this._registerToolTips();},_checkDeviceSpecific:function(){if(Backbone.Webshop.mixins.isBetaFeatureEnabled('SB_IPAD_ITEM_CONTROLS_VISIBLE')&&webshop.common.Util.isIPad()){jQ('#smartTrolley').addClass('smartTrolley-ipad');}},_observeBasketEvents:function(){document.observe('webshop:basket:update',function(evt){var jsonData=evt.memo.data;if(jsonData){var element=evt.memo.element,itemButtonsContainer=element.parents('.textBoxListAlt, .textBoxList');if(_.isArray(jsonData.errors)&&jsonData.errors[0]){if(itemButtonsContainer.length&&!itemButtonsContainer.find('.qtyWarning').length){itemButtonsContainer.append(jQ('<span class="qtyWarning">'+jsonData.errors[0]+'</span>'));}else if(this.isPicturesView()){webshop.common.Util.displayAddedMessage(jsonData.errors[0]);}}else{var SmartBasket=webshop.basket.SmartBasket,callback;itemButtonsContainer.find('span.qtyWarning').remove();if(this.isPicturesView()){callback=SmartBasket.updatePictureView;}else{callback=SmartBasket.updateTextView;}
callback.call(webshop.basket.SmartBasket,element,jsonData);}}}.bind(this));},_registerPageListeners:function(){this.registerViewOptions();this.registerQuantityControls();this.registerEmptyBasketConfirm();this.registerCopyBasket();this.registerCancelChangesConfirm();this.registerNavClickEvents();},_registerToolTips:function(){jQ('#trolleyPopup, #smartTrolley').toolTip({selector:'img.trolleyInfo',className:'trolleyInfoTip',topOffset:-100,leftOffset:0,trolleyTip:true});},registerViewOptions:function(){jQ('#sortBySelect').change(function(){jQ(this).parents('form').submit();});jQ('#checkoutSortForm').submit(function(e){var url=this.action+'?'+jQ(this).serialize();webshop.basket.SmartBasket.reload(url,{eventSource:'sortBy'});jQ('body').trigger('disposeToolTip');e.preventDefault();});jQ('#radioText, #radioPicture').click(function(){var input=jQ(this);var form=input.parents('#stView').siblings('#stSorting').find('form');var url=form.attr('action')+'?'+form.serialize();jQ('body').trigger('disposeToolTip');webshop.basket.SmartBasket.reload(url,{view:input.val(),eventSource:'tabs'});});jQ('#stTabs a').click(function(e){var pics=jQ(this).parent()[0].id=='stTabPictures';jQ('#stTabText').removeClass((pics?'':'in')+'active');jQ('#stTabText').addClass((pics?'in':'')+'active');jQ('#stTabPictures').removeClass((pics?'in':'')+'active');jQ('#stTabPictures').addClass((pics?'':'in')+'active');jQ('#centralColumn').addClass((pics?'picturePlan':''));jQ('body').trigger('disposeToolTip');webshop.basket.SmartBasket.reload(this.href,{eventSource:'tabs'});e.preventDefault();});},registerQuantityControls:function(){this.initTrolleyModel();var eventSender=new ocBackbone.gtm.TrolleyEventSender();jQ('#smartTrolley').on('click','a.increment',(function(clazz){return function(e){if(webshop.common.jsVariables.get('gaTrackBasketUpdateOnSuccess')){var domElement=this;webshop.catalogue.Util.sendUpdateBasketRequest.call(domElement,e,clazz,function(){onUpdateSuccess(domElement,clazz,'add');});}else{if(webshop.catalogue.Util.sendUpdateBasketRequest.call(this,e,clazz)){var productData=getProductData(this);if(!_.isEmpty(productData)){eventSender.addToTrolley(productData,'Smart Trolley',clazz.pageType(),'Smart Trolley');}}}};})(this));jQ('#smartTrolley').on('click','a.decrement',(function(clazz){return function(e){if(webshop.common.jsVariables.get('gaTrackBasketUpdateOnSuccess')){var domElement=this;webshop.catalogue.Util.sendUpdateBasketRequest.call(domElement,e,clazz,function(){onUpdateSuccess(domElement,clazz,'remove');});}else{if(webshop.catalogue.Util.sendUpdateBasketRequest.call(this,e,clazz)){var productData=getProductData(this);if(!_.isEmpty(productData)){eventSender.removeFromTrolley(productData,'Smart Trolley',clazz.pageType(),'Smart Trolley');}}}};})(this));jQ('#smartTrolley').on('click','a.delHover',(function(clazz){return function(e){if(webshop.common.jsVariables.get('gaTrackBasketUpdateOnSuccess')){var domElement=this;webshop.catalogue.Util.sendUpdateBasketRequest.call(domElement,e,clazz,function(){onUpdateSuccess(domElement,clazz,'removeAll');});}else{if(webshop.catalogue.Util.sendUpdateBasketRequest.call(this,e,clazz)){var productData=getProductData(this);if(!_.isEmpty(productData)){if(!clazz.isPicturesView()){productData.quantity=getProductQuantity(this);}
eventSender.removeFromTrolley(productData,'Smart Trolley',clazz.pageType(),'Smart Trolley');}}}};})(this));function getProductQuantity(button){var quantityStr=jQ(button).parents('li').find('span.quantity').text();return!_.isEmpty(quantityStr)&&Number(quantityStr)||1;}
function getProductData(button){var productData=findProductBySku(getProductSku(button));if(!_.isEmpty(productData)){return{id:productData.sku,name:productData.name,brand:productData.brand,category:productData.category,quantity:1,price:productData.price};}else{return{};}
function findProductBySku(sku){return _.find(webshop.basket.SmartBasket.getSmartTrolleyModel(),{sku:sku})||{};}
function getProductSku(button){var liId=jQ(button).parents('li').attr('id');return!_.isUndefined(liId)&&liId.replace(/^[^_]+_(\d+)$/,'$1');}}
function onUpdateSuccess(domElement,clazz,updateType){var productData=getProductData(domElement);if(!_.isEmpty(productData)){switch(updateType){case'add':{eventSender.addToTrolley(productData,'Smart Trolley',clazz.pageType(),'Smart Trolley');break;}
case'remove':{eventSender.removeFromTrolley(productData,'Smart Trolley',clazz.pageType(),'Smart Trolley');break;}
case'removeAll':{if(!clazz.isPicturesView()){productData.quantity=getProductQuantity(domElement);}
eventSender.removeFromTrolley(productData,'Smart Trolley',clazz.pageType(),'Smart Trolley');break;}
default:{break;}}}}},getSmartTrolleyModel:function(){this.initTrolleyModel();return webshop.gtm.cache.products||[];},initTrolleyModel:function(){webshop.gtm.cache=webshop.gtm.cache||{};if(_.isUndefined(webshop.gtm.cache.products)){webshop.gtm.cache.products=_.clone(webshop.common.jsVariables.get('products')||[]);}},pageType:function(){if(Backbone.Webshop.mixins.isCheckout()){return'Checkout walk';}else{return'Smart Trolley';}},registerEmptyBasketConfirm:function(){var emptyTrolley=jQ('a.emptyBasket');var eventSender=new ocBackbone.gtm.TrolleyEventSender();webshop.dialogs.ShowConfirmButton.registerPopup(emptyTrolley,'empty-trolley',{viewType:function(){return this.isPicturesView()?'picture-view':'text-view'}.bind(this),eventSender:eventSender,pageType:this.pageType()});},registerCopyBasket:function(){jQ('a.copyTrolley').on('click',function(){if(webshop.popup.utils.linkRequiresLoginPopup(this)||webshop.popup.utils.linkRequiresElevatedLoginPopup(this)){return;}
var skus={};jQ('#smartTrolley ul').last().find('li').each(function(index,input){if(input.id){var sku=input.id.replace(/^[^_]+_/,'');var img=jQ(input).find('img.productImage')[0];skus[sku]={sku:sku,url:jQ(input).find('div > a')[0].href,alt:img.alt,src:img.src,quantity:jQ(input).find('input[name=quantity]').val()};}});var skuList=[];for(var i in skus){skuList.push(skus[i]);}
if(skuList.length>0){webshop.dialogs.AddToList.showPopup(skuList,{trolley:true,source:'Front of pack'});}
return false;});},registerCancelChangesConfirm:function(){var cancelChanges=jQ('#cancelChangesForm button');webshop.dialogs.OrderConfirmCancelChanges.registerPopup(cancelChanges);},registerNavClickEvents:function(){var trackOnClick=function(event,url,name,details){var shouldNavigate=false;var timeoutId=null;if(!event.isDefaultPrevented()){event.preventDefault();shouldNavigate=true;timeoutId=window.setTimeout(function(){window.location=url;},1000);}
Backbone.Webshop.analytics.WebshopAnalytics.reportPageEvent(name,details).always(function(){if(shouldNavigate){window.clearTimeout(timeoutId);window.location=url;}});};jQ('#siteTabs a.hd-topTabs__link').on('click',function(event){var currentElement=event.currentTarget;var url=jQ(currentElement).attr('href');var name=jQ(currentElement).parent().data('name');if(_.isEmpty(url)){return;}
trackOnClick(event,url,'Top tab clicked',{LINK:url,TAG:name});});jQ('.browseShop').on('click','li > a',function(event){var currentElement=event.currentTarget;var url=jQ(currentElement).attr('href');var parentNav=jQ(currentElement).parents('.nav');var level=['baseLevel','levelOne','levelTwo'].findIndex(function(cls){return parentNav.hasClass(cls);});if(_.isEmpty(url)){return;}
trackOnClick(event,url,'Browse shop dropdown clicked',{LEVEL:level,TAG:jQ(currentElement).parent().data('option')||jQ(currentElement).text()});});},reload:function(url,values,successCallback){values=values||{};values.ignore='this';values.ajax=true;var centralColumn=jQ('#centralColumn'),content=centralColumn.length>0?centralColumn:jQ('#smartTrolley');content.load(url,values,function(){jQ('.LifeTextDate').toggle(jQ('h3.LifeDivider').length>0);if(successCallback&&typeof successCallback==='function'){successCallback();}});},updateTextView:function(element,jsonResponse){webshop.basket.SmartBasket.reload(jQ('#stTabs a').attr('href'),null,function(){var trolley=jQ('#smartTrolley'),centralColumn=jQ('#centralColumn'),content=centralColumn.length>0?centralColumn:trolley;this.updateCheckoutButton(jsonResponse.checkoutAllowed);if(content.find('li').length===1){this.displayInstantShopMessage();}}.bind(this));},updatePictureView:function(element,jsonResponse){var item=jsonResponse.lastItemUpdated,deleteAll;if(item){this.updateDepartmentHeader(element,item);this.updatePrices(jsonResponse.changedPricesPerUnit);if(this.isIncrement(element)){this.incrementPictureView(item);}else{deleteAll=!this.isDecrement(element);this.decrementPictureView(item,deleteAll);}
this.updateCheckoutButton(jsonResponse.checkoutAllowed);jQ('body').trigger('disposeToolTip');}},incrementPictureView:function(item){var li,clone;li=jQ('#item0_'+item.sku);clone=li.clone();clone.attr('id','item'+(item.itemQuantity-1)+'_'+item.sku);clone.insertAfter(li);},decrementPictureView:function(item,deleteAll){var li,trolley=jQ('#smartTrolley'),centralColumn=jQ('#centralColumn'),content=centralColumn.length>0?centralColumn:trolley;if(deleteAll){li=jQ('.'+item.sku);}else{li=jQ('#item'+item.itemQuantity+'_'+item.sku);}
if(this.isLastItemInSection(li)){li.first().prevAll('li').first().remove();}
li.remove();if(content.find('li').length===0){this.displayInstantShopMessage();}},updateCheckoutButton:function(checkoutAllowed){var checkoutButton=jQ('.ConfirmContinue');if(!checkoutAllowed){checkoutButton.find('form button').attr('disabled','');checkoutButton.find('form button').attr('class','continue disabled');}
else{checkoutButton.find('form button').removeAttr('disabled');checkoutButton.find('form button').attr('class','continue');}},updatePrices:function(changedPrices,selector){var trolley=jQ('#smartTrolley'),selectorPrefix=selector||'.price';if(changedPrices){for(var sku in changedPrices){if(changedPrices.hasOwnProperty(sku)){trolley.find(selectorPrefix+sku).html(changedPrices[sku]);}}}},updateDepartmentHeader:function(element,item){var count,li=this.getItemLi(item),header=li.prevAll('.departmentHeader:contains("'+item.department+'")');if(!header.length){return;}
var span=header.find('span[class=itemCount]');var txt=jQ.trim(span.text());var prevCount=txt.substring(1,txt.indexOf(' '));count=prevCount;if(this.isIncrement(element)){count++;}else if(this.isDecrement(element)){count--;}else{count=count-this.getItemCount(item);}
if(count!==0){span.text(txt.replace(prevCount,count));}else{header.remove();}},isLastItemInSection:function(li){var nextLi=li.last().nextAll('li').first(),prevLi=li.first().prevAll('li').first();return(!nextLi.length||nextLi.hasClass('trolley')||nextLi.hasClass('footer')||nextLi.hasClass('departmentHeader'))&&prevLi.hasClass('trolley');},displayInstantShopMessage:function(){jQ('#radioPicture:checked, #radioText:checked, #stTabs .active a').trigger('click');jQ('#centralColumn').addClass('emptyTrolleyBox');},isPicturesView:function(){return jQ('#stTabPictures[class=active]').length;},isIncrement:function(element){return element.hasClass('increment')||element.hasClass('increase');},isDecrement:function(element){return element.hasClass('decrement')||element.hasClass('decrease')||element.hasClass('delHover')&&element.parents('li').hasClass('pictureView');},getItemLi:function(item){if(this.isPicturesView()){return jQ('.'+item.sku);}else{return jQ('#item_'+item.sku);}},getItemCount:function(item){if(this.isPicturesView()){return jQ('.'+item.sku).length;}else{return jQ('#quantity'+item.sku).text().trim();}}};