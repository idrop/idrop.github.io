webshop.gtm.discountclub=webshop.gtm.discountclub||{};webshop.gtm.discountclub={utils:{pageType:function(){return Backbone.Webshop.mixins.isCheckout()?'Checkout walk':'Smart Trolley';}},init:function(){this.eventSender=new ocBackbone.gtm.ProductImpressionEventSender();var products=this.extractProducts();if(!_.isEmpty(products)){this.sendProductImpressions(products);this.mergeProductsDataIntoTrolleyModel(products);}},extractProducts:function(){var itemsInBasketEligibleForClub=webshop.common.jsVariables.get('itemsInBasketEligibleForClub');var clubItemsNotInBasket=webshop.common.jsVariables.get('clubItemsNotInBasket');var flattenedProducts=_.flatten([itemsInBasketEligibleForClub,clubItemsNotInBasket]);return _.reject(flattenedProducts,_.isUndefined);},mergeProductsDataIntoTrolleyModel:function(products){if(!_.isUndefined(webshop.basket.SmartBasket)){webshop.basket.SmartBasket.initTrolleyModel();_.each(products,function(product){webshop.gtm.cache.products.push(product);});}},sendProductImpressions:function(products){this.eventSender.sendProductImpressionWithSectionAsListName(products,'Discount Club Widget',webshop.gtm.discountclub.utils.pageType());}};webshop.discountclub=webshop.discountclub||{};webshop.discountclub.CancelMembership={init:function(){this.registerCancelMembershipConfirm();},registerCancelMembershipConfirm:function(){jQ('div.passSaving > a.passOptions').bind('click',function(){var href=jQ(this).attr('href').replace('cancelMembershipConfirmation','cancelMembership');var action=jQ(this).text().toLowerCase();var question;if(action==='refund'){question='Are you sure you want to request a refund for this subscription?';}else{question='Are you sure you want to cancel this subscription?';}
return webshop.messagebox.showConfirmButton(question,'cancelDeliveryPopup popitLeft','No, take me back',{button:'Yes, '+action+' it',wide:true,url:href});});}};webshop.discountclub=webshop.discountclub||{};webshop.discountclub.ClubWidget={init:function(){this._registerObserveBasketEvents();if(!webshop.common.Util.isIe6()){this._registerHideLoadClubItem();}},_registerObserveBasketEvents:function(){document.observe('webshop:basket:update',function(evt){var jsonData=evt.memo.data;if(jsonData){var lastItemUpdated=jsonData.lastItemUpdated,clubSavings=jsonData.clubSavings,potentialClubSavings=jsonData.potentialClubSavings;if(lastItemUpdated&&jQ('#discountClubWidget #productDetails-'+lastItemUpdated.sku+'-form').length){jQ('#checkoutSortForm').submit();}
if(jQ('#clubSavings').length){if(clubSavings&&clubSavings.length){jQ('#clubSavings').html(clubSavings.replace(/\s+/g,''));}}
if(jQ('#potentialClubSavings').length){if(potentialClubSavings&&potentialClubSavings.length){jQ('#potentialClubSavings').html(potentialClubSavings.replace(/\s+/g,''));}}
if(jsonData.errors&&evt.memo.element.parents('div#ocadoPlusWidget').length){webshop.common.Util.displayAddedMessage(jsonData.errors[0]);}}}.bind(this));},_registerHideLoadClubItem:function(){var clubItemsNotInBasketSection=jQ('#clubItemsNotInBasket');clubItemsNotInBasketSection.delegate('a.hideRecommendation','click',function(){var itemToRemove=jQ(this).parents(".product"),cross=itemToRemove.find('.hideRecommendation'),href=cross.attr('href');cross.remove();jQ.ajax({url:href,type:"POST",data:{ajax:true},success:function(itemToAdd){var itemsContainer=clubItemsNotInBasketSection.find('.productList');webshop.discountclub.ClubWidget.addItemToWidget(itemToAdd,itemsContainer);webshop.discountclub.ClubWidget.removeItemFromWidget(itemToRemove,itemsContainer,clubItemsNotInBasketSection);var widgetItemScript=jQ('#widgetItem');if(widgetItemScript.length==1){var widgetItemModel=JSON.parse(widgetItemScript.html());var positionInList=jQ(itemsContainer).find('.product').length-2;webshop.gtm.discountclub.sendProductImpressions([_.extend(widgetItemModel,{positionInList:positionInList})]);webshop.gtm.cache.products.push(widgetItemModel);widgetItemScript.remove();}}});return false;});},addItemToWidget:function(itemToAdd,itemsContainer){if(itemToAdd.match('productDetails')){itemsContainer.append(itemToAdd);itemsContainer.children().last().fadeIn('slow');}},removeItemFromWidget:function(itemToRemove,itemsContainer,clubItemsNotInBasketSection){if(itemsContainer.children().size()<2){if(jQ('#otherSavings').length){clubItemsNotInBasketSection.fadeOut('slow',function(){clubItemsNotInBasketSection.remove();});}else{jQ('#discountClubWidget').remove();jQ('#content').addClass('contentWide');}}else{itemToRemove.fadeOut('slow',function(){itemToRemove.remove();});}}};webshop.discountclub=webshop.discountclub||{};webshop.discountclub.SignUpPayment={init:function(){this.registerListeners();},registerListeners:function(){jQ('#enterNewCardLink').click(function(){jQ('#clubPaymentAddNewCard').removeClass('accessibility').show();jQ('.paymentDetails').hide();jQ('.paymentErrors').hide();return false;});jQ('#membershipTsCs').click(function(){webshop.discountclub.SignUpPayment.checkTermsAndConditionsCheckBox(true);});jQ('button.confirmPaymentContinue').click(function(){webshop.discountclub.SignUpPayment.checkTermsAndConditionsCheckBox(false);});jQ('a.tcLink').click(function(){if(jQ.browser.msie&&jQ.browser.version<7){}
else{webshop.discountclub.SignUpPayment.showTermsAndConditionsPopup();return false;}});},checkTermsAndConditionsCheckBox:function(allowEventActionToFinish){var continueBtn=jQ('button.confirmPaymentContinue');if(jQ('#membershipTsCs').attr('checked')){jQ('p.tnCsErrorMsg').hide();continueBtn.removeAttr('disabled');}
else{jQ('p.tnCsErrorMsg').show();continueBtn.attr('disabled','true');jQ('.membershipTsCs').remove();}
return allowEventActionToFinish;},showTermsAndConditionsPopup:function(){var terms=jQ('#clubTC');webshop.messagebox.createDialog({dialogClass:'dialog',innerClass:'tandcPopup',header:getMessage("other.SignUpPayment.popupHeader"),options:{height:'420px'}});webshop.messagebox.insertInner(terms.html());}};